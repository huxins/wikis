(window.webpackJsonp=window.webpackJsonp||[]).push([[112],{392:function(a,t,s){"use strict";s.r(t);var e=s(14),r=Object(e.a)({},(function(){var a=this,t=a._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[t("h1",{attrs:{id:"iptables"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#iptables"}},[a._v("#")]),a._v(" iptables")]),a._v(" "),t("p",[a._v("https://www.frozentux.net/iptables-tutorial/cn/iptables-tutorial-cn-1.1.19.html")]),a._v(" "),t("h2",{attrs:{id:"安装"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#安装"}},[a._v("#")]),a._v(" 安装")]),a._v(" "),t("ul",[t("li",[a._v("CentOS 7系统，需要关闭firewalld装回iptables.")])]),a._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 关闭firewalld服务")]),a._v("\nsystemctl stop firewalld.service\nsystemctl disable firewalld.service\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 查看firewall状态")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" systemctl status firewalld\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 检查iptables是否安装")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" systemctl status iptables\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 安装iptables")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# sudo yum install -y iptables")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 升级iptables")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# sudo yum update iptables")]),a._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 安装iptables-services")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" yum "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("install")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-y")]),a._v(" iptables-services\nsystemctl start iptables.service\nsystemctl "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("enable")]),a._v(" iptables.service\n")])])]),t("ul",[t("li",[a._v("开启系统的转发功能")])]),a._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[a._v("$ "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("vi")]),a._v(" /etc/sysctl.conf\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# net.ipv4.ip_forward = 1")]),a._v("\n$ "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("sysctl")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-p")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# CentOS 7")]),a._v("\n$ "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("echo")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v("'net.ipv4.ip_forward = 1'")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">>")]),a._v(" /usr/lib/sysctl.d/50-default.conf\n$ "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("sysctl")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-p")]),a._v(" /usr/lib/sysctl.d/50-default.conf\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 查看启动结果")]),a._v("\n$ "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("sysctl")]),a._v(" net.ipv4.ip_forward\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 如果已经启动则显示")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v(" net.ipv4.ip_forward "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("1")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 临时开启转发能力")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("echo")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("1")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v(" /proc/sys/net/ipv4/ip_forward\nsystemctl restart network.service\n")])])]),t("ul",[t("li",[a._v("基本操作")])]),a._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 查看iptables现有规则")]),a._v("\niptables "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-L")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-v")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-n")]),a._v(" --line-number\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 清空所有默认规则")]),a._v("\niptables "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-F")]),a._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 清空所有自定义规则")]),a._v("\niptables "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-X")]),a._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 所有计数器归0")]),a._v("\niptables "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-Z")]),a._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 删除INPUT中的第5个")]),a._v("\niptables "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-D")]),a._v(" INPUT "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("5")]),a._v("\n")])])]),t("ul",[t("li",[a._v("iptables 配置文件")])]),a._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 通过命令行改变iptables是临时的，永远改变iptables需要在/etc/sysconfig/iptables中写入配置")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 备份当前规则")]),a._v("\niptables-save "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v(" iptables.rules\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 将备份的规则还原")]),a._v("\niptables-restore iptables.rules\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 保存当前规则")]),a._v("\n/usr/libexec/iptables/iptables.init save\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("service")]),a._v(" iptables save\n")])])]),t("h2",{attrs:{id:"规则分类-表"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#规则分类-表"}},[a._v("#")]),a._v(" 规则分类（表）")]),a._v(" "),t("p",[a._v("filter表：负责过滤功能，防火墙；内核模块：iptables_filter")]),a._v(" "),t("p",[a._v("nat表：network address translation，网络地址转换功能；内核模块：iptable_nat")]),a._v(" "),t("p",[a._v("mangle表：拆解报文，做出修改，并重新封装 的功能；iptable_mangle")]),a._v(" "),t("p",[a._v("raw表：关闭nat表上启用的连接追踪机制；iptable_raw")]),a._v(" "),t("h2",{attrs:{id:"处理动作"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#处理动作"}},[a._v("#")]),a._v(" 处理动作")]),a._v(" "),t("p",[a._v("ACCEPT：允许数据包通过。")]),a._v(" "),t("p",[a._v("DROP：直接丢弃数据包，不给任何回应信息，这时候客户端会感觉自己的请求泥牛入海了，过了超时时间才会有反应。")]),a._v(" "),t("p",[a._v("REJECT：拒绝数据包通过，必要时会给数据发送端一个响应的信息，客户端刚请求就会收到拒绝的信息。")]),a._v(" "),t("p",[a._v("SNAT：源地址转换，解决内网用户用同一个公网地址上网的问题。")]),a._v(" "),t("p",[a._v("MASQUERADE：是SNAT的一种特殊形式，适用于动态的、临时会变的ip上。")]),a._v(" "),t("p",[a._v("DNAT：目标地址转换。")]),a._v(" "),t("p",[a._v("REDIRECT：在本机做端口映射。")]),a._v(" "),t("p",[a._v("LOG：在/var/log/messages文件中记录日志信息，然后将数据包传递给下一条规则，也就是说除了记录以外不对数据包做任何其他操作，仍然让下一条规则去匹配。")]),a._v(" "),t("h2",{attrs:{id:"应用"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#应用"}},[a._v("#")]),a._v(" 应用")]),a._v(" "),t("p",[a._v("中转")]),a._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[a._v("iptables "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-t")]),a._v(" nat "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-A")]),a._v(" PREROUTING "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-p")]),a._v(" tcp "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-d")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("本地服务器IP"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--dport")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("端口号"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-j")]),a._v(" DNAT --to-destination "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("目标IP:目标端口号"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v("\niptables "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-t")]),a._v(" nat "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-A")]),a._v(" PREROUTING "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-p")]),a._v(" udp "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-d")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("本地服务器IP"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--dport")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("端口号"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-j")]),a._v(" DNAT --to-destination "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("目标IP:目标端口号"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v("\niptables "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-t")]),a._v(" nat "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-A")]),a._v(" POSTROUTING "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-p")]),a._v(" tcp "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-d")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("目标IP"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--dport")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("目标端口号"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-j")]),a._v(" SNAT --to-source "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("本地服务器IP"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v("\niptables "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-t")]),a._v(" nat "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-A")]),a._v(" POSTROUTING "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-p")]),a._v(" udp "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-d")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("目标IP"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--dport")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("目标端口号"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-j")]),a._v(" SNAT --to-source "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("本地服务器IP"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v("\n")])])]),t("p",[a._v("开放端口")]),a._v(" "),t("p",[t("code",[a._v("dport")]),a._v(" 目的端口, "),t("code",[a._v("sport")]),a._v(" 来源端口")]),a._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[a._v("iptables "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-A")]),a._v(" INPUT "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-p")]),a._v(" tcp "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-m")]),a._v(" multiport "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--dport")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("17000,17500")]),a._v(",20000:30000 "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-j")]),a._v(" ACCEPT\niptables "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-A")]),a._v(" OUTPUT "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-p")]),a._v(" tcp "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-m")]),a._v(" multiport "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--sport")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("17000,17500")]),a._v(",20000:30000 "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-j")]),a._v(" ACCEPT\n")])])]),t("p",[a._v("端口重定向")]),a._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[a._v("iptables "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-t")]),a._v(" nat "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-A")]),a._v(" PREROUTING "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-p")]),a._v(" udp "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--dport")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("53")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-j")]),a._v(" REDIRECT --to-ports "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("5353")]),a._v("\niptables "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-t")]),a._v(" nat "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-A")]),a._v(" PREROUTING "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-p")]),a._v(" tcp "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--dport")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("53")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-j")]),a._v(" REDIRECT --to-ports "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("5353")]),a._v("\n")])])]),t("p",[a._v("限制并发连接数")]),a._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[a._v("iptables "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-I")]),a._v(" INPUT "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-p")]),a._v(" tcp "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--syn")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--dport")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("8081")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-m")]),a._v(" connlimit --connlimit-above "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("2")]),a._v(" --connlimit-mask "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-j")]),a._v(" DROP\n")])])]),t("ul",[t("li",[t("a",{attrs:{href:"http://www.zsythink.net/archives/tag/iptables/page/2/",target:"_blank",rel:"noopener noreferrer"}},[a._v("iptables详解 朱双印"),t("OutboundLink")],1)]),a._v(" "),t("li",[t("a",{attrs:{href:"https://www.jianshu.com/p/84541600a941",target:"_blank",rel:"noopener noreferrer"}},[a._v("将IPTables改造为TCP负载均衡器"),t("OutboundLink")],1)])])])}),[],!1,null,null,null);t.default=r.exports}}]);